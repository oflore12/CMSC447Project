{% extends 'base.html' %}
{% import 'search_bar.html' as search_bar %}
{% import 'score_gauge.html' as score_gauge %}
{% import 'reviews.html' as reviews %}

{% block title %}Search{% endblock %}

{% block content %}
{{ search_bar.mainSearchBar(q, provider) }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<section class="searchSection" style="flex-grow: 1">
	{% if not results %}
	<div class="searchResults noSearchResults"
		style="display: flex; flex-direction: column; align-items: center; padding: 50px 0; margin-top: 0; margin-bottom: 0">
		<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#aaa" class="bi bi-search"
			viewBox="0 0 16 16" style="display: block; width: 150px; height: 150px; margin-bottom: 20px; opacity: 0.4">
			<path
				d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
		</svg>
		<p style="display: block; text-align: center; font-size: 1.8rem; opacity: 0.8; font-weight: 600;">
			Bummer! No results found.
		</p>
	</div>
	{% endif %}

	{% for r in results %}
	<div class="searchResults">
		<a href="/details/{{r.type}}/{{r.id}}">
			{% if r.poster %}
			<img src="https://image.tmdb.org/t/p/w500{{ r.poster }}" alt="{{ r.title }}"
				class="{{'notAvail' if not r.providers.get(country)}}" onload="this.classList.add('loadedImg')" />
			{% else %}
			<div class="noPoster {{'notAvail' if not r.providers.get(country)}}"></div>
			{% endif %}
		</a>

		{{reviews.reviewsModal(r)}}

		<div style="min-width: 0">
			<div
				style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 13px; margin-bottom: 22px;">
				<a href="/details/{{r.type}}/{{r.id}}" class="searchResultTitle"
					style="font-weight: 600; font-size: 28px; margin: 14px 0 0; line-height: 1; color: black;">
					<span>{{r.title}}</span>
					{% if r.year %}
					<span style="font-size: 20px; font-weight: 400; padding-left: 3px; opacity: 0.8;">
						({{ r.year }})
					</span>
					{% endif %}
				</a>

				<div style="display: flex; margin-bottom: -4px; margin-left: 50px; font-size: 25px;">
					{% if current_user.is_authenticated %}
					<button class="watchlistButton" id="watchlist-{{r.type}}-{{r.id}}" data-is-added="{{r.watchlist}}">
						<span id="add" style="pointer-events: none">
							<i class="bi bi-bookmark" id="empty" style="pointer-events: none"></i>
      						<i class="bi bi-bookmark-plus" id="plus" style="pointer-events: none"></i>
						</span>
						<span id="remove" style="pointer-events: none">
							<i class="bi bi-bookmark-fill" id="fill" style="pointer-events: none"></i>
							<i class="bi bi-bookmark-dash" id="dash" style="pointer-events: none"></i>
						</span>
					</button>
					{% endif %}

					{% if r.score_count == 0 %}
					<div style="cursor: default;">
						{{ score_gauge.scoreGaugeSmall(r.score, r.score_count) }}
					</div>
					{% else %}
					<div style="margin-bottom: -3px;">
						<div data-bs-toggle="modal" data-bs-target="#reviews-{{r.id}}" style="cursor: pointer;">
							{{ score_gauge.scoreGaugeSmall(r.score, r.score_count) }}
						</div>
					</div>
					{% endif %}
				</div>
			</div>

			<div class="provTray">
				{% if r.providers.get(country).flatrate %}
				<div class="provRow">
					<div class="provColumn vertical" style="background: rgba(0,0,0,0.9)">STREAM</div>
					<div class="provColumn icons">
						{% for f in r.providers.get(country).flatrate %}
						<div class="iconContainer">
							{% set imageUrl = "https://image.tmdb.org/t/p/w500" + f.logo_path %}
							<img src="{{imageUrl}}" alt="{{f.provider_name}}" width="75" height="75"
								onload="this.classList.add('loadedImg')" data-bs-toggle="tooltip"
								data-bs-title="{{f.provider_name}}" data-bs-custom-class="custom-tooltip" />
						</div>
						{% endfor %}
					</div>
				</div>
				{% endif %}

				{% if r.providers.get(country).buy %}
				<div class="provRow">
					<div class="provColumn vertical" style="background: rgba(0,0,0,0.7)">BUY</div>
					<div class="provColumn icons">
						{% for b in r.providers.get(country).buy %}
						<div class="iconContainer">
							{% set imageUrl = "https://image.tmdb.org/t/p/w500" + b.logo_path %}
							<img src="{{imageUrl}}" alt="{{b.provider_name}}" width="75" height="75"
								onload="this.classList.add('loadedImg')" data-bs-toggle="tooltip"
								data-bs-title="{{b.provider_name}}" data-bs-custom-class="custom-tooltip" />
						</div>
						{% endfor %}
					</div>
				</div>
				{% endif %}

				{% if r.providers.get(country).rent %}
				<div class="provRow">
					<div class="provColumn vertical" style="background: rgba(0,0,0,0.45)">RENT</div>
					<div class="provColumn icons">
						{% for p in r.providers.get(country).rent %}
						<div class="iconContainer">
							{% set imageUrl = "https://image.tmdb.org/t/p/w500" + p.logo_path %}
							<img src="{{imageUrl}}" alt="{{p.provider_name}}" width="75" height="75"
								onload="this.classList.add('loadedImg')" data-bs-toggle="tooltip"
								data-bs-title="{{p.provider_name}}" data-bs-custom-class="custom-tooltip" />
						</div>
						{% endfor %}
					</div>
				</div>
				{% endif %}

				{% if r.providers.get(country).ads %}
				<div class="provRow">
					<div class="provColumn vertical" style="background: rgba(0,0,0,0.25); color: black">ADS</div>
					<div class="provColumn icons">
						{% for a in r.providers.get(country).ads %}
						<div class="iconContainer">
							{% set imageUrl = "https://image.tmdb.org/t/p/w500" + a.logo_path %}
							<img src="{{imageUrl}}" alt="{{a.provider_name}}" width="75" height="75"
								onload="this.classList.add('loadedImg')" data-bs-toggle="tooltip"
								data-bs-title="{{a.provider_name}}" data-bs-custom-class="custom-tooltip" />
						</div>
						{% endfor %}
					</div>
				</div>
				{% endif %}

				{% if r.providers.get(country).free %}
				<div class="provRow">
					<div class="provColumn vertical" style="background: rgba(0,0,0,0.1); color: black">FREE</div>
					<div class="provColumn icons">
						{% for f in r.providers.get(country).free %}
						<div class="iconContainer">
							{% set imageUrl = "https://image.tmdb.org/t/p/w500" + f.logo_path %}
							<img src="{{imageUrl}}" alt="{{f.provider_name}}" width="75" height="75"
								onload="this.classList.add('loadedImg')" data-bs-toggle="tooltip"
								data-bs-title="{{f.provider_name}}" data-bs-custom-class="custom-tooltip" />
						</div>
						{% endfor %}
					</div>
				</div>
				{% endif %}
			</div>

			{% if not r.providers.get(country) %}
			<p class="notAvailableMsg">Not available from any streaming providers.</p>
			{% endif %}
		</div>
	</div>
	{% endfor %}
</section>

<script>
	const outerHeight = (el) => {
		var height = el.offsetHeight;
		var style = window.getComputedStyle(el);
		height += parseInt(style.marginTop) + parseInt(style.marginBottom);
		return height;
	};

	const spaceNoResults = () => {
		let searchSection = document.querySelector('.searchSection')
		let noResults = document.querySelector('.searchResults.noSearchResults')
		if (noResults) {
			const inner = function () {
				let space = (outerHeight(searchSection) - noResults.clientHeight) / 2
				noResults.style.marginTop = space + 'px'
			}
			searchSection.addEventListener("animationstart", inner)
			window.addEventListener('resize', inner)
		}
	}

	spaceNoResults();

	function addButtonClicked(type, itemId, isAdded) {
		let newStatus = isAdded === 'True' ? 'remove' : 'add';
		document.getElementById(`watchlist-${type}-${itemId}`).classList.add('disabled')
		fetch(`/watchlist/${newStatus}/${type}/${itemId}`)
			.then(response => {
				return response.json();
			})
			.then(data => {
				document.getElementById(`watchlist-${type}-${itemId}`).dataset.isAdded = isAdded === 'True' ? 'False' : 'True';
				console.log(data)
			})
			.catch(error => {
				console.error('Error removing item from watchlist:', error);
			})
			.finally(() => {
				document.getElementById(`watchlist-${type}-${itemId}`).classList.remove('disabled')
			});
	}

	document.addEventListener('click', function (event) {
		if (event.target.matches('.watchlistButton')) {
			let info = event.target.id.split('-')
			addButtonClicked(info[1], info[2], event.target.dataset.isAdded)
		}
	}, false);
</script>
{% endblock %}